name: Update zeta_flutter

on:
  workflow_dispatch:
  workflow_call:
    secrets:
      PAT:
        required: true

jobs:
  publish_flutter:
    runs-on: ubuntu-latest
    name: Commit and raise PR in Zeta Flutter
    steps:
      - name: Set environment variables
        run: |
          echo "flutter_branch=update-zeta-icons" >> $GITHUB_ENV
          echo "flutter_repo=ZebraDevs/zeta_flutter" >> $GITHUB_ENV
      - name: Check if existing icons branch exists
        run: echo "branch_exists=$(git ls-remote --heads https://github.com/${{env.flutter_repo}}.git refs/heads/${{env.flutter_branch}} | wc -l)" >> $GITHUB_ENV
      - name: Check if open PR exists
        run: echo "pr_exists=$(curl https://api.github.com/repos/${{env.flutter_repo}}/pulls?head=ZebraDevs:${{env.flutter_branch}} | jq length)" >> $GITHUB_ENV
      - name: Retrieve PR number
        run: echo "pr_num=$(curl https://api.github.com/repos/${{env.flutter_repo}}/pulls?head=ZebraDevs:${{env.flutter_branch}} | jq .[0].number)" >> $GITHUB_ENV
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          ref: ${{github.ref_name}}
      - name: Get package version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.3.1
      - name: Push dart file to Zeta Flutter (branch exists)
        uses: dmnemec/copy_file_to_another_repo_action@main
        if: ${{env.branch_exists == 1}}
        env:
          API_TOKEN_GITHUB: ${{ secrets.PAT }}
        with:
          #TODO: pass file paths as inputs
          source_file: "./outputs/definitions/icons.dart"
          destination_repo: "${{env.flutter_repo}}"
          destination_folder: "lib/src/assets"
          destination_branch: "${{env.flutter_branch}}"
          user_email: "zeta-icons-bot@github.com"
          user_name: "zeta-icons-bot"
          commit_message: "icons.dart"
      - name: Push dart file to Zeta Flutter (branch does not exist)
        if: ${{env.branch_exists == 0}}
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.PAT }}
        with:
          #TODO: pass file paths as inputs
          source_file: "./outputs/definitions/icons.dart"
          destination_repo: "${{env.flutter_repo}}"
          destination_folder: "lib/src/assets"
          destination_branch_create: "${{env.flutter_branch}}"
          user_email: "zeta-icons-bot@github.com"
          user_name: "zeta-icons-bot"
          commit_message: "icons.dart"
      - name: Push round icon font file to Zeta Flutter
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.PAT }}
        with:
          source_file: "./outputs/font/zeta-icons-round.ttf"
          destination_repo: "${{env.flutter_repo}}"
          destination_folder: "lib/src/assets/fonts"
          destination_branch: "${{env.flutter_branch}}"
          user_email: "zeta-icons-bot@github.com"
          user_name: "zeta-icons-bot"
          commit_message: "rounded font file"
      - name: Push sharp icon font file to Zeta Flutter
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.PAT }}
        with:
          source_file: "./outputs/font/zeta-icons-sharp.ttf"
          destination_repo: "${{env.flutter_repo}}"
          destination_folder: "lib/src/assets/fonts"
          destination_branch: "${{env.flutter_branch}}"
          user_email: "zeta-icons-bot@github.com"
          user_name: "zeta-icons-bot"
          commit_message: "sharp font file"
      - name: Create PR message
        run: echo "pr_message=Updating to icons version ${{ steps.package-version.outputs.current-version }}" >> $GITHUB_ENV
      - name: Open Zeta Flutter PR
        uses: thecanadianroot/open-pull-request-action@v1.1.1
        if: ${{env.pr_exists == 0}}
        with:
          token: ${{ secrets.PAT }}
          base: main
          head: ${{env.flutter_branch}}
          title: "deps: Update zeta-icon library"
          labels: icons
          body: "${{env.pr_message}}"
          repository: ${{env.flutter_repo}}
      - name: Add comment to existing PR
        if: ${{env.pr_exists != 0}}
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.PAT}}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{env.pr_num}},
              owner: "ZebraDevs",
              repo: "zeta_flutter",
              body: '${{env.pr_message}}'
            })
